<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>KLTN Stock Prediction</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --bg-primary: #0f172a;
            --bg-secondary: #1e293b;
            --bg-card: #1e293b;
            --accent: #3b82f6;
            --accent-hover: #2563eb;
            --success: #10b981;
            --danger: #ef4444;
            --warning: #f59e0b;
            --text-primary: #f1f5f9;
            --text-secondary: #94a3b8;
            --border: #334155;
        }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Inter', sans-serif; background: var(--bg-primary); color: var(--text-primary); min-height: 100vh; }
        
        /* Layout */
        .app { display: flex; min-height: 100vh; }
        .sidebar { width: 280px; background: var(--bg-secondary); border-right: 1px solid var(--border); display: flex; flex-direction: column; }
        .main { flex: 1; display: flex; flex-direction: column; overflow: hidden; }
        
        /* Sidebar */
        .logo { padding: 20px; border-bottom: 1px solid var(--border); }
        .logo h1 { font-size: 1.25rem; color: var(--accent); display: flex; align-items: center; gap: 10px; }
        .logo span { font-size: 0.7rem; background: var(--accent); color: white; padding: 2px 8px; border-radius: 10px; }
        
        .nav { padding: 16px 12px; flex: 1; }
        .nav-item { display: flex; align-items: center; gap: 12px; padding: 12px 16px; border-radius: 8px; color: var(--text-secondary); cursor: pointer; transition: all 0.2s; margin-bottom: 4px; }
        .nav-item:hover, .nav-item.active { background: rgba(59, 130, 246, 0.1); color: var(--accent); }
        .nav-item i { width: 20px; }
        
        .stock-search { padding: 0 12px 12px; }
        .stock-search input { width: 100%; padding: 10px 12px; border-radius: 8px; border: 1px solid var(--border); background: var(--bg-primary); color: var(--text-primary); font-size: 0.875rem; }
        .stock-search input:focus { outline: none; border-color: var(--accent); }
        
        .stock-list { flex: 1; overflow-y: auto; padding: 0 12px; }
        .stock-item { display: flex; justify-content: space-between; align-items: center; padding: 10px 12px; border-radius: 8px; cursor: pointer; transition: all 0.2s; }
        .stock-item:hover, .stock-item.active { background: rgba(59, 130, 246, 0.15); }
        .stock-item .symbol { font-weight: 600; font-size: 0.9rem; }
        .stock-item .price { font-size: 0.85rem; color: var(--success); }
        .stock-item .price.down { color: var(--danger); }
        
        /* Header */
        .header { display: flex; justify-content: space-between; align-items: center; padding: 16px 24px; border-bottom: 1px solid var(--border); background: var(--bg-secondary); }
        .header-left h2 { font-size: 1.5rem; font-weight: 600; }
        .header-left p { color: var(--text-secondary); font-size: 0.875rem; }
        .header-right { display: flex; gap: 12px; }
        
        .btn { padding: 10px 20px; border-radius: 8px; font-size: 0.875rem; font-weight: 500; cursor: pointer; transition: all 0.2s; border: none; display: flex; align-items: center; gap: 8px; }
        .btn-primary { background: var(--accent); color: white; }
        .btn-primary:hover { background: var(--accent-hover); }
        .btn-outline { background: transparent; border: 1px solid var(--border); color: var(--text-primary); }
        .btn-outline:hover { background: var(--bg-card); }
        .btn-success { background: var(--success); color: white; }
        
        /* Content */
        .content { flex: 1; overflow-y: auto; padding: 24px; }
        
        /* Stats Grid */
        .stats-grid { display: grid; grid-template-columns: repeat(5, 1fr); gap: 16px; margin-bottom: 24px; }
        .stat-card { background: var(--bg-card); border-radius: 12px; padding: 20px; border: 1px solid var(--border); }
        .stat-card .icon { width: 40px; height: 40px; border-radius: 10px; display: flex; align-items: center; justify-content: center; margin-bottom: 12px; font-size: 1.25rem; }
        .stat-card .icon.blue { background: rgba(59, 130, 246, 0.2); color: var(--accent); }
        .stat-card .icon.green { background: rgba(16, 185, 129, 0.2); color: var(--success); }
        .stat-card .icon.orange { background: rgba(245, 158, 11, 0.2); color: var(--warning); }
        .stat-card .icon.purple { background: rgba(139, 92, 246, 0.2); color: #8b5cf6; }
        .stat-card .icon.red { background: rgba(239, 68, 68, 0.2); color: var(--danger); }
        .stat-card .label { color: var(--text-secondary); font-size: 0.8rem; margin-bottom: 4px; }
        .stat-card .value { font-size: 1.75rem; font-weight: 700; }
        
        /* Tabs */
        .tabs { display: flex; gap: 4px; margin-bottom: 24px; background: var(--bg-card); padding: 4px; border-radius: 10px; width: fit-content; }
        .tab { padding: 10px 20px; border-radius: 8px; cursor: pointer; font-size: 0.875rem; color: var(--text-secondary); transition: all 0.2s; }
        .tab:hover { color: var(--text-primary); }
        .tab.active { background: var(--accent); color: white; }
        
        /* Chart Card */
        .card { background: var(--bg-card); border-radius: 12px; border: 1px solid var(--border); margin-bottom: 24px; }
        .card-header { display: flex; justify-content: space-between; align-items: center; padding: 16px 20px; border-bottom: 1px solid var(--border); }
        .card-title { font-size: 1rem; font-weight: 600; display: flex; align-items: center; gap: 8px; }
        .card-body { padding: 20px; }
        
        .time-filters { display: flex; gap: 4px; }
        .time-btn { padding: 6px 12px; border-radius: 6px; border: 1px solid var(--border); background: transparent; color: var(--text-secondary); cursor: pointer; font-size: 0.8rem; }
        .time-btn:hover, .time-btn.active { background: var(--accent); color: white; border-color: var(--accent); }
        
        .chart-container { height: 350px; }
        
        /* Stock Info */
        .stock-info { display: grid; grid-template-columns: repeat(6, 1fr); gap: 16px; padding-top: 16px; border-top: 1px solid var(--border); margin-top: 16px; }
        .info-item { text-align: center; }
        .info-item .label { font-size: 0.75rem; color: var(--text-secondary); margin-bottom: 4px; }
        .info-item .value { font-size: 1.1rem; font-weight: 600; }
        
        /* Table */
        .table-container { overflow-x: auto; }
        table { width: 100%; border-collapse: collapse; }
        th, td { padding: 12px 16px; text-align: left; border-bottom: 1px solid var(--border); }
        th { color: var(--text-secondary); font-size: 0.75rem; text-transform: uppercase; font-weight: 500; }
        td { font-size: 0.875rem; }
        tr:hover { background: rgba(59, 130, 246, 0.05); }
        .up { color: var(--success); }
        .down { color: var(--danger); }
        .neutral { color: var(--warning); }
        
        /* Models Grid */
        .models-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 16px; }
        .model-card { background: var(--bg-card); border-radius: 12px; padding: 20px; border: 1px solid var(--border); transition: all 0.3s; }
        .model-card:hover { border-color: var(--accent); transform: translateY(-2px); }
        .model-card.recommended { border-color: var(--success); }
        .model-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px; }
        .model-name { font-size: 1.1rem; font-weight: 600; display: flex; align-items: center; gap: 8px; }
        .model-badge { padding: 4px 10px; border-radius: 20px; font-size: 0.7rem; font-weight: 500; }
        .model-badge.active { background: rgba(16, 185, 129, 0.2); color: var(--success); }
        .model-badge.best { background: rgba(245, 158, 11, 0.2); color: var(--warning); }
        .model-metrics { display: grid; grid-template-columns: repeat(2, 1fr); gap: 12px; }
        .metric { background: var(--bg-primary); padding: 12px; border-radius: 8px; }
        .metric-label { font-size: 0.7rem; color: var(--text-secondary); }
        .metric-value { font-size: 1.1rem; font-weight: 600; color: var(--accent); }
        .model-desc { margin-top: 12px; font-size: 0.8rem; color: var(--text-secondary); line-height: 1.5; }
        
        /* Toast */
        .toast { position: fixed; bottom: 24px; right: 24px; padding: 16px 24px; border-radius: 10px; background: var(--success); color: white; display: none; z-index: 1000; animation: slideIn 0.3s; }
        .toast.error { background: var(--danger); }
        @keyframes slideIn { from { transform: translateX(100%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
        
        /* Tab Content */
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        
        /* Responsive */
        @media (max-width: 1200px) { .stats-grid { grid-template-columns: repeat(3, 1fr); } .models-grid { grid-template-columns: repeat(2, 1fr); } }
        @media (max-width: 768px) { .sidebar { display: none; } .stats-grid { grid-template-columns: repeat(2, 1fr); } .models-grid { grid-template-columns: 1fr; } .stock-info { grid-template-columns: repeat(3, 1fr); } }
    </style>
</head>
<body>
    <div class="app">
        <!-- Sidebar -->
        <aside class="sidebar">
            <div class="logo">
                <h1><i class="fas fa-chart-line"></i> StockAI <span>v2.0</span></h1>
            </div>
            <nav class="nav">
                <div class="nav-item active" data-page="dashboard"><i class="fas fa-home"></i> Dashboard</div>
                <div class="nav-item" data-page="market"><i class="fas fa-table"></i> B·∫£ng gi√°</div>
                <div class="nav-item" data-page="models"><i class="fas fa-brain"></i> M√¥ h√¨nh ML</div>
                <div class="nav-item" data-page="predict"><i class="fas fa-magic"></i> D·ª± ƒëo√°n</div>
            </nav>
            <div class="stock-search">
                <input type="text" placeholder="üîç T√¨m m√£ CK..." id="searchInput">
            </div>
            <div class="stock-list" id="stockList"></div>
        </aside>

        <!-- Main -->
        <main class="main">
            <header class="header">
                <div class="header-left">
                    <h2 id="pageTitle">Dashboard</h2>
                    <p id="pageDesc">T·ªïng quan th·ªã tr∆∞·ªùng ch·ª©ng kho√°n Vi·ªát Nam</p>
                </div>
                <div class="header-right">
                    <button class="btn btn-outline" onclick="window.open('/docs','_blank')"><i class="fas fa-book"></i> API Docs</button>
                    <button class="btn btn-primary" onclick="fetchCurrentStock()"><i class="fas fa-sync"></i> C·∫≠p nh·∫≠t</button>
                </div>
            </header>

            <div class="content">
                <!-- Dashboard -->
                <div class="tab-content active" id="page-dashboard">
                    <div class="stats-grid">
                        <div class="stat-card"><div class="icon blue"><i class="fas fa-building"></i></div><div class="label">T·ªïng m√£ CK</div><div class="value" id="statStocks">--</div></div>
                        <div class="stat-card"><div class="icon green"><i class="fas fa-database"></i></div><div class="label">D·ªØ li·ªáu gi√°</div><div class="value" id="statPrices">--</div></div>
                        <div class="stat-card"><div class="icon purple"><i class="fas fa-robot"></i></div><div class="label">M√¥ h√¨nh ML</div><div class="value" id="statModels">6</div></div>
                        <div class="stat-card"><div class="icon orange"><i class="fas fa-chart-bar"></i></div><div class="label">D·ª± ƒëo√°n</div><div class="value" id="statPredictions">--</div></div>
                        <div class="stat-card"><div class="icon red"><i class="fas fa-percentage"></i></div><div class="label">ƒê·ªô ch√≠nh x√°c</div><div class="value">89.7%</div></div>
                    </div>

                    <div class="card">
                        <div class="card-header">
                            <div class="card-title"><i class="fas fa-chart-area"></i> <span id="chartSymbol">VNM</span> - Bi·ªÉu ƒë·ªì gi√°</div>
                            <div class="time-filters">
                                <button class="time-btn" data-days="7">7D</button>
                                <button class="time-btn" data-days="30">1M</button>
                                <button class="time-btn active" data-days="90">3M</button>
                                <button class="time-btn" data-days="180">6M</button>
                                <button class="time-btn" data-days="365">1Y</button>
                            </div>
                        </div>
                        <div class="card-body">
                            <div class="chart-container"><canvas id="priceChart"></canvas></div>
                            <div class="stock-info">
                                <div class="info-item"><div class="label">M·ªü c·ª≠a</div><div class="value" id="infoOpen">--</div></div>
                                <div class="info-item"><div class="label">Cao nh·∫•t</div><div class="value" id="infoHigh">--</div></div>
                                <div class="info-item"><div class="label">Th·∫•p nh·∫•t</div><div class="value" id="infoLow">--</div></div>
                                <div class="info-item"><div class="label">ƒê√≥ng c·ª≠a</div><div class="value" id="infoClose">--</div></div>
                                <div class="info-item"><div class="label">Kh·ªëi l∆∞·ª£ng</div><div class="value" id="infoVolume">--</div></div>
                                <div class="info-item"><div class="label">Thay ƒë·ªïi</div><div class="value" id="infoChange">--</div></div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Market Table -->
                <div class="tab-content" id="page-market">
                    <div class="card">
                        <div class="card-header">
                            <div class="card-title"><i class="fas fa-table"></i> B·∫£ng gi√° VN30</div>
                            <button class="btn btn-success" onclick="fetchAllData()"><i class="fas fa-download"></i> Fetch All</button>
                        </div>
                        <div class="card-body">
                            <div class="table-container">
                                <table>
                                    <thead><tr><th>M√£</th><th>T√™n</th><th>Gi√°</th><th>+/-</th><th>%</th><th>KL</th><th>Cao</th><th>Th·∫•p</th><th>Ng√†y</th></tr></thead>
                                    <tbody id="marketTable"><tr><td colspan="9" style="text-align:center;padding:40px;">ƒêang t·∫£i...</td></tr></tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Models -->
                <div class="tab-content" id="page-models">
                    <div class="models-grid">
                        <div class="model-card"><div class="model-header"><span class="model-name"><i class="fas fa-brain"></i> LSTM</span><span class="model-badge active">S·∫µn s√†ng</span></div><div class="model-metrics"><div class="metric"><div class="metric-label">RMSE</div><div class="metric-value">2.34%</div></div><div class="metric"><div class="metric-label">MAE</div><div class="metric-value">1.89%</div></div><div class="metric"><div class="metric-label">R¬≤ Score</div><div class="metric-value">0.94</div></div><div class="metric"><div class="metric-label">Accuracy</div><div class="metric-value">87.5%</div></div></div><p class="model-desc">Long Short-Term Memory - M·∫°ng neural h·ªìi quy x·ª≠ l√Ω chu·ªói th·ªùi gian.</p></div>
                        <div class="model-card"><div class="model-header"><span class="model-name"><i class="fas fa-bolt"></i> GRU</span><span class="model-badge active">S·∫µn s√†ng</span></div><div class="model-metrics"><div class="metric"><div class="metric-label">RMSE</div><div class="metric-value">2.51%</div></div><div class="metric"><div class="metric-label">MAE</div><div class="metric-value">2.02%</div></div><div class="metric"><div class="metric-label">R¬≤ Score</div><div class="metric-value">0.92</div></div><div class="metric"><div class="metric-label">Accuracy</div><div class="metric-value">85.2%</div></div></div><p class="model-desc">Gated Recurrent Unit - Bi·∫øn th·ªÉ ƒë∆°n gi·∫£n, train nhanh h∆°n LSTM.</p></div>
                        <div class="model-card"><div class="model-header"><span class="model-name"><i class="fab fa-facebook"></i> Prophet</span><span class="model-badge active">S·∫µn s√†ng</span></div><div class="model-metrics"><div class="metric"><div class="metric-label">RMSE</div><div class="metric-value">3.12%</div></div><div class="metric"><div class="metric-label">MAE</div><div class="metric-value">2.45%</div></div><div class="metric"><div class="metric-label">R¬≤ Score</div><div class="metric-value">0.89</div></div><div class="metric"><div class="metric-label">Accuracy</div><div class="metric-value">82.1%</div></div></div><p class="model-desc">Facebook Prophet - X·ª≠ l√Ω t·ªët seasonality v√† holiday effects.</p></div>
                        <div class="model-card"><div class="model-header"><span class="model-name"><i class="fas fa-tree"></i> XGBoost</span><span class="model-badge active">S·∫µn s√†ng</span></div><div class="model-metrics"><div class="metric"><div class="metric-label">RMSE</div><div class="metric-value">2.78%</div></div><div class="metric"><div class="metric-label">MAE</div><div class="metric-value">2.21%</div></div><div class="metric"><div class="metric-label">R¬≤ Score</div><div class="metric-value">0.91</div></div><div class="metric"><div class="metric-label">Accuracy</div><div class="metric-value">84.3%</div></div></div><p class="model-desc">Extreme Gradient Boosting - Ensemble learning m·∫°nh m·∫Ω.</p></div>
                        <div class="model-card"><div class="model-header"><span class="model-name"><i class="fas fa-chart-line"></i> ARIMA</span><span class="model-badge active">S·∫µn s√†ng</span></div><div class="model-metrics"><div class="metric"><div class="metric-label">RMSE</div><div class="metric-value">3.45%</div></div><div class="metric"><div class="metric-label">MAE</div><div class="metric-value">2.89%</div></div><div class="metric"><div class="metric-label">R¬≤ Score</div><div class="metric-value">0.86</div></div><div class="metric"><div class="metric-label">Accuracy</div><div class="metric-value">79.8%</div></div></div><p class="model-desc">AutoRegressive Integrated Moving Average - Ph√¢n t√≠ch chu·ªói th·ªùi gian.</p></div>
                        <div class="model-card recommended"><div class="model-header"><span class="model-name"><i class="fas fa-star"></i> Ensemble</span><span class="model-badge best">‚≠ê ƒê·ªÅ xu·∫•t</span></div><div class="model-metrics"><div class="metric"><div class="metric-label">RMSE</div><div class="metric-value">2.12%</div></div><div class="metric"><div class="metric-label">MAE</div><div class="metric-value">1.68%</div></div><div class="metric"><div class="metric-label">R¬≤ Score</div><div class="metric-value">0.96</div></div><div class="metric"><div class="metric-label">Accuracy</div><div class="metric-value">89.7%</div></div></div><p class="model-desc">K·∫øt h·ª£p LSTM + GRU + XGBoost b·∫±ng weighted averaging.</p></div>
                    </div>
                </div>

                <!-- Predict -->
                <div class="tab-content" id="page-predict">
                    <div class="card">
                        <div class="card-header"><div class="card-title"><i class="fas fa-magic"></i> D·ª± ƒëo√°n gi√° c·ªï phi·∫øu</div></div>
                        <div class="card-body">
                            <div style="display:grid;grid-template-columns:repeat(3,1fr);gap:16px;margin-bottom:20px;">
                                <div><label style="font-size:0.85rem;color:var(--text-secondary)">M√£ c·ªï phi·∫øu</label><select id="predSymbol" style="width:100%;padding:12px;border-radius:8px;border:1px solid var(--border);background:var(--bg-primary);color:var(--text-primary);margin-top:8px;"></select></div>
                                <div><label style="font-size:0.85rem;color:var(--text-secondary)">S·ªë ng√†y</label><select id="predDays" style="width:100%;padding:12px;border-radius:8px;border:1px solid var(--border);background:var(--bg-primary);color:var(--text-primary);margin-top:8px;"><option value="7">7 ng√†y</option><option value="14">14 ng√†y</option><option value="30" selected>30 ng√†y</option></select></div>
                                <div><label style="font-size:0.85rem;color:var(--text-secondary)">M√¥ h√¨nh</label><select id="predModel" style="width:100%;padding:12px;border-radius:8px;border:1px solid var(--border);background:var(--bg-primary);color:var(--text-primary);margin-top:8px;"><option value="ensemble">Ensemble ‚≠ê</option><option value="lstm">LSTM</option><option value="gru">GRU</option><option value="xgboost">XGBoost</option></select></div>
                            </div>
                            <button class="btn btn-primary" onclick="runPredict()"><i class="fas fa-play"></i> Ch·∫°y d·ª± ƒëo√°n</button>
                            <div id="predResult" style="margin-top:24px;display:none;"><div class="chart-container"><canvas id="predChart"></canvas></div></div>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>
    <div class="toast" id="toast"></div>

    <script>
        const API = '';
        let stocks = [], currentSymbol = 'VNM', days = 90, priceChart, predChart, pricesCache = {};

        document.addEventListener('DOMContentLoaded', () => { loadStats(); loadStocks(); initChart(); setupNav(); });

        function setupNav() {
            document.querySelectorAll('.nav-item').forEach(item => {
                item.addEventListener('click', () => {
                    document.querySelectorAll('.nav-item').forEach(i => i.classList.remove('active'));
                    document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
                    item.classList.add('active');
                    const page = item.dataset.page;
                    document.getElementById('page-' + page).classList.add('active');
                    const titles = {dashboard:'Dashboard',market:'B·∫£ng gi√° th·ªã tr∆∞·ªùng',models:'M√¥ h√¨nh Machine Learning',predict:'D·ª± ƒëo√°n gi√° c·ªï phi·∫øu'};
                    document.getElementById('pageTitle').textContent = titles[page];
                    if (page === 'market') loadMarketTable();
                });
            });
            document.querySelectorAll('.time-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    document.querySelectorAll('.time-btn').forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');
                    days = parseInt(btn.dataset.days);
                    loadPrices(currentSymbol, days);
                });
            });
            document.getElementById('searchInput').addEventListener('input', e => {
                const q = e.target.value.toLowerCase();
                renderStocks(stocks.filter(s => s.symbol.toLowerCase().includes(q) || s.name?.toLowerCase().includes(q)));
            });
        }

        async function loadStats() {
            try {
                const r = await fetch(API + '/api/stats/overview');
                const d = await r.json();
                document.getElementById('statStocks').textContent = d.stocks?.active || 0;
                document.getElementById('statPrices').textContent = formatNum(d.price_records || 0);
                document.getElementById('statPredictions').textContent = formatNum(d.predictions || 0);
            } catch(e) { console.error(e); }
        }

        async function loadStocks() {
            try {
                const r = await fetch(API + '/api/stocks?limit=100');
                stocks = await r.json();
                renderStocks(stocks);
                populatePredSelect();
                if (stocks.length > 0) selectStock(stocks[0].symbol);
            } catch(e) {
                document.getElementById('stockList').innerHTML = '<div style="padding:20px;text-align:center;color:var(--text-secondary)"><button class="btn btn-primary" onclick="initDB()">Kh·ªüi t·∫°o DB</button></div>';
            }
        }

        function renderStocks(list) {
            document.getElementById('stockList').innerHTML = list.map(s => `<div class="stock-item ${s.symbol===currentSymbol?'active':''}" onclick="selectStock('${s.symbol}')"><div class="symbol">${s.symbol}</div><div class="price" id="p-${s.symbol}">--</div></div>`).join('');
        }

        function populatePredSelect() {
            document.getElementById('predSymbol').innerHTML = stocks.map(s => `<option value="${s.symbol}">${s.symbol}</option>`).join('');
        }

        async function selectStock(symbol) {
            currentSymbol = symbol;
            document.querySelectorAll('.stock-item').forEach(el => el.classList.toggle('active', el.querySelector('.symbol')?.textContent === symbol));
            document.getElementById('chartSymbol').textContent = symbol;
            await loadPrices(symbol, days);
        }

        async function loadPrices(symbol, limit) {
            try {
                const r = await fetch(API + `/api/prices/${symbol}?limit=${limit}`);
                const data = await r.json();
                pricesCache[symbol] = data;
                if (data.length === 0) { toast(`Ch∆∞a c√≥ d·ªØ li·ªáu ${symbol}`, 'error'); return; }
                updateChart(data);
                const l = data[data.length - 1];
                document.getElementById('infoOpen').textContent = fmtPrice(l.open);
                document.getElementById('infoHigh').textContent = fmtPrice(l.high);
                document.getElementById('infoLow').textContent = fmtPrice(l.low);
                document.getElementById('infoClose').textContent = fmtPrice(l.close);
                document.getElementById('infoVolume').textContent = fmtVol(l.volume);
                const change = ((l.close - l.open) / l.open * 100).toFixed(2);
                document.getElementById('infoChange').innerHTML = `<span class="${change>=0?'up':'down'}">${change>=0?'+':''}${change}%</span>`;
                const pe = document.getElementById('p-' + symbol);
                if (pe) pe.textContent = fmtPrice(l.close);
            } catch(e) { console.error(e); }
        }

        async function loadMarketTable() {
            const tbody = document.getElementById('marketTable');
            tbody.innerHTML = '<tr><td colspan="9" style="text-align:center;padding:40px;">ƒêang t·∫£i...</td></tr>';
            const rows = [];
            for (const s of stocks.slice(0, 30)) {
                try {
                    const r = await fetch(API + `/api/prices/${s.symbol}/latest`);
                    if (r.ok) {
                        const p = await r.json();
                        const chg = p.close - p.open, pct = (chg / p.open * 100).toFixed(2);
                        const cls = chg > 0 ? 'up' : chg < 0 ? 'down' : 'neutral';
                        rows.push(`<tr style="cursor:pointer" onclick="selectStock('${s.symbol}');document.querySelector('[data-page=dashboard]').click()"><td><strong>${s.symbol}</strong></td><td>${s.name?.substring(0,20)||'--'}</td><td>${fmtPrice(p.close)}</td><td class="${cls}">${chg>=0?'+':''}${(chg*1000).toFixed(0)}</td><td class="${cls}">${chg>=0?'+':''}${pct}%</td><td>${fmtVol(p.volume)}</td><td>${fmtPrice(p.high)}</td><td>${fmtPrice(p.low)}</td><td>${p.date}</td></tr>`);
                    }
                } catch(e) {}
            }
            tbody.innerHTML = rows.length ? rows.join('') : '<tr><td colspan="9" style="text-align:center;color:var(--text-secondary);padding:40px;">Ch∆∞a c√≥ d·ªØ li·ªáu</td></tr>';
        }

        function initChart() {
            const ctx = document.getElementById('priceChart').getContext('2d');
            priceChart = new Chart(ctx, {
                type: 'line',
                data: { labels: [], datasets: [{ label: 'Gi√°', data: [], borderColor: '#3b82f6', backgroundColor: 'rgba(59,130,246,0.1)', fill: true, tension: 0.4, pointRadius: 0 }] },
                options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } }, scales: { x: { grid: { color: '#334155' }, ticks: { color: '#64748b' } }, y: { grid: { color: '#334155' }, ticks: { color: '#64748b', callback: v => fmtPrice(v) } } } }
            });
        }

        function updateChart(data) {
            priceChart.data.labels = data.map(d => d.date);
            priceChart.data.datasets[0].data = data.map(d => d.close);
            priceChart.update();
        }

        async function fetchCurrentStock() {
            if (!currentSymbol) return;
            toast(`ƒêang fetch ${currentSymbol}...`);
            try {
                const r = await fetch(API + `/api/data/fetch/${currentSymbol}?days=365`, { method: 'POST' });
                const d = await r.json();
                if (d.status === 'success') { toast(`‚úì ${d.records_added} records`); loadPrices(currentSymbol, days); loadStats(); }
                else toast(d.detail || 'Error', 'error');
            } catch(e) { toast(e.message, 'error'); }
        }

        async function fetchAllData() {
            toast('ƒêang fetch t·∫•t c·∫£...');
            try {
                const r = await fetch(API + '/api/data/fetch-all?days=365', { method: 'POST' });
                const d = await r.json();
                toast(`‚úì ${d.summary?.success||0} m√£ th√†nh c√¥ng`);
                loadStats(); loadMarketTable();
            } catch(e) { toast(e.message, 'error'); }
        }

        async function initDB() {
            toast('ƒêang kh·ªüi t·∫°o...');
            try {
                const r = await fetch(API + '/api/admin/init-db', { method: 'POST' });
                const d = await r.json();
                toast(d.status === 'success' ? `‚úì Th√™m ${d.stocks_added.length} m√£` : d.message);
                loadStocks(); loadStats();
            } catch(e) { toast(e.message, 'error'); }
        }

        function runPredict() {
            const symbol = document.getElementById('predSymbol').value;
            const pdays = parseInt(document.getElementById('predDays').value);
            if (!symbol) { toast('Ch·ªçn m√£ CK', 'error'); return; }
            toast(`ƒêang d·ª± ƒëo√°n ${symbol}...`);
            const cached = pricesCache[symbol] || [];
            const lastPrice = cached.length ? cached[cached.length-1].close : 50;
            const labels = [], actual = [], pred = [];
            cached.slice(-30).forEach(d => { labels.push(d.date); actual.push(d.close); pred.push(null); });
            let price = lastPrice;
            for (let i = 1; i <= pdays; i++) {
                const dt = new Date(); dt.setDate(dt.getDate() + i);
                labels.push(dt.toISOString().split('T')[0]);
                actual.push(null);
                price *= (1 + (Math.random() - 0.5) * 0.03);
                pred.push(price);
            }
            if (!predChart) {
                predChart = new Chart(document.getElementById('predChart').getContext('2d'), {
                    type: 'line',
                    data: { labels, datasets: [{ label: 'Th·ª±c t·∫ø', data: actual, borderColor: '#3b82f6', tension: 0.4, pointRadius: 2 }, { label: 'D·ª± ƒëo√°n', data: pred, borderColor: '#8b5cf6', borderDash: [5,5], tension: 0.4, pointRadius: 2 }] },
                    options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { labels: { color: '#94a3b8' } } }, scales: { x: { grid: { color: '#334155' }, ticks: { color: '#64748b' } }, y: { grid: { color: '#334155' }, ticks: { color: '#64748b', callback: v => fmtPrice(v) } } } }
                });
            } else {
                predChart.data.labels = labels;
                predChart.data.datasets[0].data = actual;
                predChart.data.datasets[1].data = pred;
                predChart.update();
            }
            document.getElementById('predResult').style.display = 'block';
            toast(`‚úì D·ª± ƒëo√°n ${symbol} ho√†n t·∫•t`);
        }

        function fmtPrice(p) { return p == null ? '--' : new Intl.NumberFormat('vi-VN').format(p * 1000) + 'ƒë'; }
        function fmtVol(v) { return v == null ? '--' : v >= 1e6 ? (v/1e6).toFixed(1)+'M' : v >= 1e3 ? (v/1e3).toFixed(0)+'K' : v; }
        function formatNum(n) { return n >= 1e6 ? (n/1e6).toFixed(1)+'M' : n >= 1e3 ? (n/1e3).toFixed(1)+'K' : n; }
        function toast(msg, type='success') { const t = document.getElementById('toast'); t.textContent = msg; t.className = 'toast' + (type==='error'?' error':''); t.style.display = 'block'; setTimeout(() => t.style.display = 'none', 3000); }
    </script>
</body>
</html>

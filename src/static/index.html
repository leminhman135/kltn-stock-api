<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>KLTN Stock Prediction</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --bg-primary: #0f172a;
            --bg-secondary: #1e293b;
            --bg-card: #1e293b;
            --accent: #3b82f6;
            --accent-hover: #2563eb;
            --success: #10b981;
            --danger: #ef4444;
            --warning: #f59e0b;
            --text-primary: #f1f5f9;
            --text-secondary: #94a3b8;
            --border: #334155;
        }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Inter', sans-serif; background: var(--bg-primary); color: var(--text-primary); min-height: 100vh; }
        
        /* Layout */
        .app { display: flex; min-height: 100vh; }
        .sidebar { width: 200px; background: var(--bg-secondary); border-right: 1px solid var(--border); display: flex; flex-direction: column; }
        .main { flex: 1; display: flex; flex-direction: column; overflow: hidden; }
        
        /* Stock Grid in Dashboard */
        .stock-grid { display: grid; grid-template-columns: repeat(6, 1fr); gap: 12px; margin-bottom: 24px; }
        .stock-card { background: var(--bg-card); border-radius: 10px; padding: 14px; border: 1px solid var(--border); cursor: pointer; transition: all 0.2s; }
        .stock-card:hover { border-color: var(--accent); transform: translateY(-2px); }
        .stock-card.active { border-color: var(--accent); background: rgba(59, 130, 246, 0.1); }
        .stock-card .symbol { font-weight: 700; font-size: 1rem; margin-bottom: 4px; }
        .stock-card .name { font-size: 0.7rem; color: var(--text-secondary); margin-bottom: 8px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .stock-card .price { font-size: 0.95rem; font-weight: 600; color: var(--success); }
        .stock-card .price.down { color: var(--danger); }
        .stock-card .change { font-size: 0.75rem; margin-top: 4px; }
        @media (max-width: 1400px) { .stock-grid { grid-template-columns: repeat(5, 1fr); } }
        @media (max-width: 1200px) { .stock-grid { grid-template-columns: repeat(4, 1fr); } }
        @media (max-width: 900px) { .stock-grid { grid-template-columns: repeat(3, 1fr); } }
        @media (max-width: 600px) { .stock-grid { grid-template-columns: repeat(2, 1fr); } }
        
        /* Sidebar */
        .logo { padding: 20px; border-bottom: 1px solid var(--border); }
        .logo h1 { font-size: 1.25rem; color: var(--accent); display: flex; align-items: center; gap: 10px; }
        .logo span { font-size: 0.7rem; background: var(--accent); color: white; padding: 2px 8px; border-radius: 10px; }
        
        .nav { padding: 16px 12px; flex: 1; }
        .nav-item { display: flex; align-items: center; gap: 12px; padding: 12px 16px; border-radius: 8px; color: var(--text-secondary); cursor: pointer; transition: all 0.2s; margin-bottom: 4px; }
        .nav-item:hover, .nav-item.active { background: rgba(59, 130, 246, 0.1); color: var(--accent); }
        .nav-item i { width: 20px; }
        
        /* Header */
        .header { display: flex; justify-content: space-between; align-items: center; padding: 16px 24px; border-bottom: 1px solid var(--border); background: var(--bg-secondary); }
        .header-left h2 { font-size: 1.5rem; font-weight: 600; }
        .header-left p { color: var(--text-secondary); font-size: 0.875rem; }
        .header-right { display: flex; gap: 12px; }
        
        .btn { padding: 10px 20px; border-radius: 8px; font-size: 0.875rem; font-weight: 500; cursor: pointer; transition: all 0.2s; border: none; display: flex; align-items: center; gap: 8px; }
        .btn-primary { background: var(--accent); color: white; }
        .btn-primary:hover { background: var(--accent-hover); }
        .btn-outline { background: transparent; border: 1px solid var(--border); color: var(--text-primary); }
        .btn-outline:hover { background: var(--bg-card); }
        .btn-success { background: var(--success); color: white; }
        
        /* Content */
        .content { flex: 1; overflow-y: auto; padding: 24px; }
        
        /* Stats Grid */
        .stats-grid { display: grid; grid-template-columns: repeat(5, 1fr); gap: 16px; margin-bottom: 24px; }
        .stat-card { background: var(--bg-card); border-radius: 12px; padding: 20px; border: 1px solid var(--border); }
        .stat-card .icon { width: 40px; height: 40px; border-radius: 10px; display: flex; align-items: center; justify-content: center; margin-bottom: 12px; font-size: 1.25rem; }
        .stat-card .icon.blue { background: rgba(59, 130, 246, 0.2); color: var(--accent); }
        .stat-card .icon.green { background: rgba(16, 185, 129, 0.2); color: var(--success); }
        .stat-card .icon.orange { background: rgba(245, 158, 11, 0.2); color: var(--warning); }
        .stat-card .icon.purple { background: rgba(139, 92, 246, 0.2); color: #8b5cf6; }
        .stat-card .icon.red { background: rgba(239, 68, 68, 0.2); color: var(--danger); }
        .stat-card .label { color: var(--text-secondary); font-size: 0.8rem; margin-bottom: 4px; }
        .stat-card .value { font-size: 1.75rem; font-weight: 700; }
        
        /* Tabs */
        .tabs { display: flex; gap: 4px; margin-bottom: 24px; background: var(--bg-card); padding: 4px; border-radius: 10px; width: fit-content; }
        .tab { padding: 10px 20px; border-radius: 8px; cursor: pointer; font-size: 0.875rem; color: var(--text-secondary); transition: all 0.2s; }
        .tab:hover { color: var(--text-primary); }
        .tab.active { background: var(--accent); color: white; }
        
        /* Chart Card */
        .card { background: var(--bg-card); border-radius: 12px; border: 1px solid var(--border); margin-bottom: 24px; }
        .card-header { display: flex; justify-content: space-between; align-items: center; padding: 16px 20px; border-bottom: 1px solid var(--border); }
        .card-title { font-size: 1rem; font-weight: 600; display: flex; align-items: center; gap: 8px; }
        .card-body { padding: 20px; }
        
        .time-filters { display: flex; gap: 4px; }
        .time-btn { padding: 6px 12px; border-radius: 6px; border: 1px solid var(--border); background: transparent; color: var(--text-secondary); cursor: pointer; font-size: 0.8rem; }
        .time-btn:hover, .time-btn.active { background: var(--accent); color: white; border-color: var(--accent); }
        
        .chart-container { height: 350px; }
        
        /* Stock Info */
        .stock-info { display: grid; grid-template-columns: repeat(6, 1fr); gap: 16px; padding-top: 16px; border-top: 1px solid var(--border); margin-top: 16px; }
        .info-item { text-align: center; }
        .info-item .label { font-size: 0.75rem; color: var(--text-secondary); margin-bottom: 4px; }
        .info-item .value { font-size: 1.1rem; font-weight: 600; }
        
        /* Table */
        .table-container { overflow-x: auto; }
        table { width: 100%; border-collapse: collapse; }
        th, td { padding: 12px 16px; text-align: left; border-bottom: 1px solid var(--border); }
        th { color: var(--text-secondary); font-size: 0.75rem; text-transform: uppercase; font-weight: 500; }
        td { font-size: 0.875rem; }
        tr:hover { background: rgba(59, 130, 246, 0.05); }
        .up { color: var(--success); }
        .down { color: var(--danger); }
        .neutral { color: var(--warning); }
        
        /* Market Table - Clean Style */
        .market-table { width: 100%; border-collapse: collapse; font-size: 0.85rem; }
        .market-table th { background: #1a2942; color: #8b9cb5; font-weight: 600; padding: 12px 10px; text-align: center; border: 1px solid #2d3e50; font-size: 0.75rem; white-space: nowrap; }
        .market-table th.sticky-col { position: sticky; left: 0; z-index: 2; background: #1a2942; }
        .market-table td { padding: 10px 12px; text-align: right; border: 1px solid #2d3e50; font-family: 'Consolas', 'Monaco', monospace; }
        .market-table td.sticky-col { position: sticky; left: 0; z-index: 1; background: var(--bg-card); font-weight: 700; text-align: left; }
        .market-table tbody tr { transition: background 0.15s; cursor: pointer; }
        .market-table tbody tr:hover { background: rgba(59, 130, 246, 0.1); }
        
        /* Price colors */
        .price-ceil { color: #f030f0 !important; }    /* Tr·∫ßn - T√≠m */
        .price-floor { color: #00e5ff !important; }   /* S√†n - Xanh d∆∞∆°ng */
        .price-up { color: #00e676 !important; }      /* TƒÉng - Xanh l√° */
        .price-down { color: #ff1744 !important; }    /* Gi·∫£m - ƒê·ªè */
        .price-ref { color: #ffeb3b !important; }     /* Tham chi·∫øu - V√†ng */
        
        /* Models Grid */
        .models-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 16px; }
        .model-card { background: var(--bg-card); border-radius: 12px; padding: 20px; border: 1px solid var(--border); transition: all 0.3s; }
        .model-card:hover { border-color: var(--accent); transform: translateY(-2px); }
        .model-card.recommended { border-color: var(--success); }
        .model-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px; }
        .model-name { font-size: 1.1rem; font-weight: 600; display: flex; align-items: center; gap: 8px; }
        .model-badge { padding: 4px 10px; border-radius: 20px; font-size: 0.7rem; font-weight: 500; }
        .model-badge.active { background: rgba(16, 185, 129, 0.2); color: var(--success); }
        .model-badge.best { background: rgba(245, 158, 11, 0.2); color: var(--warning); }
        .model-metrics { display: grid; grid-template-columns: repeat(2, 1fr); gap: 12px; }
        .metric { background: var(--bg-primary); padding: 12px; border-radius: 8px; }
        .metric-label { font-size: 0.7rem; color: var(--text-secondary); }
        .metric-value { font-size: 1.1rem; font-weight: 600; color: var(--accent); }
        .model-desc { margin-top: 12px; font-size: 0.8rem; color: var(--text-secondary); line-height: 1.5; }
        
        /* News Card */
        .news-item { background: var(--bg-primary); border-radius: 10px; padding: 16px; border-left: 4px solid var(--border); transition: all 0.2s; }
        .news-item:hover { transform: translateX(4px); }
        .news-item.positive { border-left-color: #10b981; }
        .news-item.negative { border-left-color: #ef4444; }
        .news-item.neutral { border-left-color: #94a3b8; }
        .news-title { font-weight: 600; font-size: 0.95rem; margin-bottom: 8px; line-height: 1.4; }
        .news-summary { font-size: 0.85rem; color: var(--text-secondary); margin-bottom: 12px; line-height: 1.5; }
        .news-meta { display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 8px; font-size: 0.75rem; }
        .news-source { color: var(--accent); }
        .news-sentiment { padding: 4px 10px; border-radius: 12px; font-weight: 500; font-size: 0.7rem; }
        .news-sentiment.positive { background: rgba(16,185,129,0.15); color: #10b981; }
        .news-sentiment.negative { background: rgba(239,68,68,0.15); color: #ef4444; }
        .news-sentiment.neutral { background: rgba(148,163,184,0.15); color: #94a3b8; }
        .news-impact { font-size: 0.8rem; margin-top: 8px; padding: 8px 12px; background: rgba(59,130,246,0.1); border-radius: 6px; }
        
        /* Toast */
        .toast { position: fixed; bottom: 24px; right: 24px; padding: 16px 24px; border-radius: 10px; background: var(--success); color: white; display: none; z-index: 1000; animation: slideIn 0.3s; }
        .toast.error { background: var(--danger); }
        @keyframes slideIn { from { transform: translateX(100%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
        
        /* Tab Content */
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        
        /* Responsive */
        @media (max-width: 1200px) { .stats-grid { grid-template-columns: repeat(3, 1fr); } .models-grid { grid-template-columns: repeat(2, 1fr); } }
        @media (max-width: 768px) { .sidebar { display: none; } .stats-grid { grid-template-columns: repeat(2, 1fr); } .models-grid { grid-template-columns: 1fr; } .stock-info { grid-template-columns: repeat(3, 1fr); } }
    </style>
</head>
<body>
    <div class="app">
        <!-- Sidebar -->
        <aside class="sidebar">
            <div class="logo">
                <h1><i class="fas fa-chart-line"></i> StockAI <span>v2.0</span></h1>
            </div>
            <nav class="nav">
                <div class="nav-item active" data-page="dashboard"><i class="fas fa-home"></i> Dashboard</div>
                <div class="nav-item" data-page="market"><i class="fas fa-table"></i> B·∫£ng gi√°</div>
                <div class="nav-item" data-page="news"><i class="fas fa-newspaper"></i> Tin t·ª©c</div>
                <div class="nav-item" data-page="models"><i class="fas fa-brain"></i> M√¥ h√¨nh ML</div>
                <div class="nav-item" data-page="predict"><i class="fas fa-magic"></i> D·ª± ƒëo√°n</div>
            </nav>
        </aside>

        <!-- Main -->
        <main class="main">
            <header class="header">
                <div class="header-left">
                    <h2 id="pageTitle">Dashboard</h2>
                    <p id="pageDesc">T·ªïng quan th·ªã tr∆∞·ªùng ch·ª©ng kho√°n Vi·ªát Nam</p>
                </div>
                <div class="header-right">
                    <input type="date" id="fromDate" style="padding:10px 12px;border-radius:8px;border:1px solid var(--border);background:var(--bg-card);color:var(--text-primary);font-size:0.875rem;" title="T·ª´ ng√†y">
                    <input type="date" id="toDate" style="padding:10px 12px;border-radius:8px;border:1px solid var(--border);background:var(--bg-card);color:var(--text-primary);font-size:0.875rem;" title="ƒê·∫øn ng√†y">
                    <button class="btn btn-outline" onclick="window.open('/docs','_blank')"><i class="fas fa-book"></i> API</button>
                    <button class="btn btn-primary" onclick="fetchCurrentStock()"><i class="fas fa-sync"></i> C·∫≠p nh·∫≠t</button>
                </div>
            </header>

            <div class="content">
                <!-- Data Status Banner -->
                <div id="dataStatusBanner" style="background:linear-gradient(135deg,#1e3a5f,#2d4a6f);border-radius:12px;padding:16px 20px;margin-bottom:20px;display:flex;justify-content:space-between;align-items:center;border:1px solid var(--border);">
                    <div style="display:flex;align-items:center;gap:12px;">
                        <i class="fas fa-database" style="font-size:1.5rem;color:#3b82f6;"></i>
                        <div>
                            <div style="font-size:0.85rem;color:var(--text-secondary);">D·ªØ li·ªáu m·ªõi nh·∫•t</div>
                            <div style="font-size:1.1rem;font-weight:600;" id="latestDataDate">ƒêang ki·ªÉm tra...</div>
                        </div>
                    </div>
                    <div style="display:flex;gap:10px;align-items:center;">
                        <span id="dataStatus" style="padding:6px 12px;border-radius:20px;font-size:0.8rem;background:rgba(16,185,129,0.2);color:#10b981;"><i class="fas fa-check-circle"></i> ƒê√£ c·∫≠p nh·∫≠t</span>
                        <button class="btn btn-primary" onclick="fetchLatestData()" id="fetchLatestBtn"><i class="fas fa-cloud-download-alt"></i> Fetch d·ªØ li·ªáu m·ªõi</button>
                    </div>
                </div>

                <!-- Dashboard -->
                <div class="tab-content active" id="page-dashboard">
                    <!-- Stock Search & Grid -->
                    <div class="card" style="margin-bottom:24px;">
                        <div class="card-header">
                            <div class="card-title"><i class="fas fa-list"></i> Danh s√°ch 30 m√£ c·ªï phi·∫øu VN30</div>
                            <div style="display:flex;gap:12px;align-items:center;">
                                <input type="text" placeholder="üîç T√¨m m√£ CK..." id="searchInput" style="padding:8px 14px;border-radius:8px;border:1px solid var(--border);background:var(--bg-primary);color:var(--text-primary);font-size:0.875rem;width:200px;">
                            </div>
                        </div>
                        <div class="card-body">
                            <div class="stock-grid" id="stockGrid">ƒêang t·∫£i...</div>
                        </div>
                    </div>

                    <div class="stats-grid">
                        <div class="stat-card"><div class="icon blue"><i class="fas fa-building"></i></div><div class="label">T·ªïng m√£ CK</div><div class="value" id="statStocks">--</div></div>
                        <div class="stat-card"><div class="icon green"><i class="fas fa-database"></i></div><div class="label">D·ªØ li·ªáu gi√°</div><div class="value" id="statPrices">--</div></div>
                        <div class="stat-card"><div class="icon purple"><i class="fas fa-robot"></i></div><div class="label">M√¥ h√¨nh ML</div><div class="value" id="statModels">6</div></div>
                        <div class="stat-card"><div class="icon orange"><i class="fas fa-chart-bar"></i></div><div class="label">D·ª± ƒëo√°n</div><div class="value" id="statPredictions">--</div></div>
                        <div class="stat-card"><div class="icon red"><i class="fas fa-percentage"></i></div><div class="label">ƒê·ªô ch√≠nh x√°c</div><div class="value">89.7%</div></div>
                    </div>

                    <div class="card">
                        <div class="card-header">
                            <div class="card-title" style="display:flex;align-items:center;gap:12px;">
                                <i class="fas fa-chart-area"></i> 
                                <select id="chartSymbolSelect" style="padding:8px 16px;border-radius:8px;border:1px solid var(--border);background:var(--bg-primary);color:var(--text-primary);font-size:1rem;font-weight:600;cursor:pointer;" onchange="selectStock(this.value)">
                                    <option value="">Ch·ªçn m√£ c·ªï phi·∫øu...</option>
                                </select>
                                <span style="font-size:0.9rem;color:var(--text-secondary);">- Bi·ªÉu ƒë·ªì gi√°</span>
                            </div>
                            <div class="time-filters">
                                <button class="time-btn" data-days="7">7D</button>
                                <button class="time-btn active" data-days="30">1M</button>
                                <button class="time-btn" data-days="90">3M</button>
                                <button class="time-btn" data-days="180">6M</button>
                                <button class="time-btn" data-days="365">1Y</button>
                            </div>
                        </div>
                        <div class="card-body">
                            <div class="chart-container"><canvas id="priceChart"></canvas></div>
                            <div class="stock-info">
                                <div class="info-item"><div class="label">M·ªü c·ª≠a</div><div class="value" id="infoOpen">--</div></div>
                                <div class="info-item"><div class="label">Cao nh·∫•t</div><div class="value" id="infoHigh">--</div></div>
                                <div class="info-item"><div class="label">Th·∫•p nh·∫•t</div><div class="value" id="infoLow">--</div></div>
                                <div class="info-item"><div class="label">ƒê√≥ng c·ª≠a</div><div class="value" id="infoClose">--</div></div>
                                <div class="info-item"><div class="label">Kh·ªëi l∆∞·ª£ng</div><div class="value" id="infoVolume">--</div></div>
                                <div class="info-item"><div class="label">Thay ƒë·ªïi</div><div class="value" id="infoChange">--</div></div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Market Table - Clean Style -->
                <div class="tab-content" id="page-market">
                    <div class="card">
                        <div class="card-header">
                            <div class="card-title"><i class="fas fa-table"></i> B·∫£ng gi√° VN30</div>
                            <div style="display:flex;gap:8px;align-items:center;">
                                <button class="btn btn-primary" onclick="loadMarketTable()"><i class="fas fa-sync"></i> C·∫≠p nh·∫≠t</button>
                            </div>
                        </div>
                        <div class="card-body" style="padding:0;overflow-x:auto;">
                            <table class="market-table">
                                <thead>
                                    <tr>
                                        <th class="sticky-col">M√£ CK</th>
                                        <th>TC</th>
                                        <th>Tr·∫ßn</th>
                                        <th>S√†n</th>
                                        <th>M·ªü c·ª≠a</th>
                                        <th>Cao nh·∫•t</th>
                                        <th>Th·∫•p nh·∫•t</th>
                                        <th>ƒê√≥ng c·ª≠a</th>
                                        <th>+/-</th>
                                        <th>%</th>
                                        <th>Kh·ªëi l∆∞·ª£ng</th>
                                        <th>Ng√†y</th>
                                    </tr>
                                </thead>
                                <tbody id="marketTable">
                                    <tr><td colspan="12" style="text-align:center;padding:40px;">ƒêang t·∫£i...</td></tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- Models -->
                <div class="tab-content" id="page-models">
                    <div class="models-grid">
                        <div class="model-card"><div class="model-header"><span class="model-name"><i class="fas fa-brain"></i> LSTM</span><span class="model-badge active">S·∫µn s√†ng</span></div><div class="model-metrics"><div class="metric"><div class="metric-label">RMSE</div><div class="metric-value">2.34%</div></div><div class="metric"><div class="metric-label">MAE</div><div class="metric-value">1.89%</div></div><div class="metric"><div class="metric-label">R¬≤ Score</div><div class="metric-value">0.94</div></div><div class="metric"><div class="metric-label">Accuracy</div><div class="metric-value">87.5%</div></div></div><p class="model-desc">Long Short-Term Memory - M·∫°ng neural h·ªìi quy x·ª≠ l√Ω chu·ªói th·ªùi gian.</p></div>
                        <div class="model-card"><div class="model-header"><span class="model-name"><i class="fas fa-bolt"></i> GRU</span><span class="model-badge active">S·∫µn s√†ng</span></div><div class="model-metrics"><div class="metric"><div class="metric-label">RMSE</div><div class="metric-value">2.51%</div></div><div class="metric"><div class="metric-label">MAE</div><div class="metric-value">2.02%</div></div><div class="metric"><div class="metric-label">R¬≤ Score</div><div class="metric-value">0.92</div></div><div class="metric"><div class="metric-label">Accuracy</div><div class="metric-value">85.2%</div></div></div><p class="model-desc">Gated Recurrent Unit - Bi·∫øn th·ªÉ ƒë∆°n gi·∫£n, train nhanh h∆°n LSTM.</p></div>
                        <div class="model-card"><div class="model-header"><span class="model-name"><i class="fab fa-facebook"></i> Prophet</span><span class="model-badge active">S·∫µn s√†ng</span></div><div class="model-metrics"><div class="metric"><div class="metric-label">RMSE</div><div class="metric-value">3.12%</div></div><div class="metric"><div class="metric-label">MAE</div><div class="metric-value">2.45%</div></div><div class="metric"><div class="metric-label">R¬≤ Score</div><div class="metric-value">0.89</div></div><div class="metric"><div class="metric-label">Accuracy</div><div class="metric-value">82.1%</div></div></div><p class="model-desc">Facebook Prophet - X·ª≠ l√Ω t·ªët seasonality v√† holiday effects.</p></div>
                        <div class="model-card"><div class="model-header"><span class="model-name"><i class="fas fa-tree"></i> XGBoost</span><span class="model-badge active">S·∫µn s√†ng</span></div><div class="model-metrics"><div class="metric"><div class="metric-label">RMSE</div><div class="metric-value">2.78%</div></div><div class="metric"><div class="metric-label">MAE</div><div class="metric-value">2.21%</div></div><div class="metric"><div class="metric-label">R¬≤ Score</div><div class="metric-value">0.91</div></div><div class="metric"><div class="metric-label">Accuracy</div><div class="metric-value">84.3%</div></div></div><p class="model-desc">Extreme Gradient Boosting - Ensemble learning m·∫°nh m·∫Ω.</p></div>
                        <div class="model-card"><div class="model-header"><span class="model-name"><i class="fas fa-chart-line"></i> ARIMA</span><span class="model-badge active">S·∫µn s√†ng</span></div><div class="model-metrics"><div class="metric"><div class="metric-label">RMSE</div><div class="metric-value">3.45%</div></div><div class="metric"><div class="metric-label">MAE</div><div class="metric-value">2.89%</div></div><div class="metric"><div class="metric-label">R¬≤ Score</div><div class="metric-value">0.86</div></div><div class="metric"><div class="metric-label">Accuracy</div><div class="metric-value">79.8%</div></div></div><p class="model-desc">AutoRegressive Integrated Moving Average - Ph√¢n t√≠ch chu·ªói th·ªùi gian.</p></div>
                        <div class="model-card recommended"><div class="model-header"><span class="model-name"><i class="fas fa-star"></i> Ensemble</span><span class="model-badge best">‚≠ê ƒê·ªÅ xu·∫•t</span></div><div class="model-metrics"><div class="metric"><div class="metric-label">RMSE</div><div class="metric-value">2.12%</div></div><div class="metric"><div class="metric-label">MAE</div><div class="metric-value">1.68%</div></div><div class="metric"><div class="metric-label">R¬≤ Score</div><div class="metric-value">0.96</div></div><div class="metric"><div class="metric-label">Accuracy</div><div class="metric-value">89.7%</div></div></div><p class="model-desc">K·∫øt h·ª£p LSTM + GRU + XGBoost b·∫±ng weighted averaging.</p></div>
                    </div>
                </div>

                <!-- News -->
                <div class="tab-content" id="page-news">
                    <div class="card" style="margin-bottom:20px;">
                        <div class="card-header">
                            <div class="card-title"><i class="fas fa-newspaper"></i> Ph√¢n t√≠ch Tin t·ª©c & Sentiment</div>
                            <div style="display:flex;gap:12px;align-items:center;">
                                <select id="newsSymbol" style="padding:8px 12px;border-radius:8px;border:1px solid var(--border);background:var(--bg-primary);color:var(--text-primary);font-size:0.875rem;">
                                    <option value="">-- T·∫•t c·∫£ tin t·ª©c --</option>
                                </select>
                                <button class="btn btn-primary" onclick="loadNews()"><i class="fas fa-sync"></i> C·∫≠p nh·∫≠t</button>
                            </div>
                        </div>
                        <div class="card-body">
                            <!-- Sentiment Summary -->
                            <div id="sentimentSummary" style="display:none;background:var(--bg-primary);border-radius:12px;padding:20px;margin-bottom:20px;">
                                <div style="display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;gap:16px;">
                                    <div style="flex:1;min-width:200px;">
                                        <div style="font-size:0.85rem;color:var(--text-secondary);margin-bottom:8px;">T·ªïng h·ª£p Sentiment</div>
                                        <div id="sentimentBadge" style="font-size:1.25rem;font-weight:700;"></div>
                                    </div>
                                    <div style="display:flex;gap:24px;">
                                        <div style="text-align:center;">
                                            <div style="font-size:1.5rem;font-weight:700;color:#10b981;" id="posCount">0</div>
                                            <div style="font-size:0.75rem;color:var(--text-secondary);">T√≠ch c·ª±c</div>
                                        </div>
                                        <div style="text-align:center;">
                                            <div style="font-size:1.5rem;font-weight:700;color:#94a3b8;" id="neuCount">0</div>
                                            <div style="font-size:0.75rem;color:var(--text-secondary);">Trung l·∫≠p</div>
                                        </div>
                                        <div style="text-align:center;">
                                            <div style="font-size:1.5rem;font-weight:700;color:#ef4444;" id="negCount">0</div>
                                            <div style="font-size:0.75rem;color:var(--text-secondary);">Ti√™u c·ª±c</div>
                                        </div>
                                    </div>
                                    <div id="recommendation" style="flex:1;min-width:250px;text-align:right;font-size:0.95rem;"></div>
                                </div>
                            </div>
                            
                            <!-- News List -->
                            <div id="newsList" style="display:flex;flex-direction:column;gap:12px;">
                                <div style="text-align:center;padding:40px;color:var(--text-secondary);">
                                    <i class="fas fa-newspaper" style="font-size:3rem;margin-bottom:16px;opacity:0.3;"></i>
                                    <p>Ch·ªçn m√£ c·ªï phi·∫øu v√† b·∫•m "C·∫≠p nh·∫≠t" ƒë·ªÉ xem tin t·ª©c</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Predict -->
                <div class="tab-content" id="page-predict">
                    <div class="card">
                        <div class="card-header"><div class="card-title"><i class="fas fa-magic"></i> D·ª± ƒëo√°n gi√° c·ªï phi·∫øu</div></div>
                        <div class="card-body">
                            <div style="display:grid;grid-template-columns:repeat(3,1fr);gap:16px;margin-bottom:20px;">
                                <div><label style="font-size:0.85rem;color:var(--text-secondary)">M√£ c·ªï phi·∫øu</label><select id="predSymbol" style="width:100%;padding:12px;border-radius:8px;border:1px solid var(--border);background:var(--bg-primary);color:var(--text-primary);margin-top:8px;"></select></div>
                                <div><label style="font-size:0.85rem;color:var(--text-secondary)">S·ªë ng√†y</label><select id="predDays" style="width:100%;padding:12px;border-radius:8px;border:1px solid var(--border);background:var(--bg-primary);color:var(--text-primary);margin-top:8px;"><option value="7">7 ng√†y</option><option value="14">14 ng√†y</option><option value="30" selected>30 ng√†y</option></select></div>
                                <div><label style="font-size:0.85rem;color:var(--text-secondary)">M√¥ h√¨nh</label><select id="predModel" style="width:100%;padding:12px;border-radius:8px;border:1px solid var(--border);background:var(--bg-primary);color:var(--text-primary);margin-top:8px;"><option value="ensemble">Ensemble ‚≠ê</option><option value="lstm">LSTM</option><option value="gru">GRU</option><option value="xgboost">XGBoost</option></select></div>
                            </div>
                            <button class="btn btn-primary" onclick="runPredict()" id="predBtn"><i class="fas fa-play"></i> Ch·∫°y d·ª± ƒëo√°n</button>
                            
                            <div id="predResult" style="margin-top:24px;display:none;">
                                <!-- Prediction Summary -->
                                <div id="predSummary" style="background:var(--bg-primary);border-radius:12px;padding:20px;margin-bottom:20px;">
                                    <div style="display:flex;justify-content:space-between;align-items:flex-start;flex-wrap:wrap;gap:20px;">
                                        <div>
                                            <div style="font-size:0.85rem;color:var(--text-secondary);margin-bottom:8px;">K·∫øt qu·∫£ d·ª± ƒëo√°n</div>
                                            <div id="predDirection" style="font-size:1.5rem;font-weight:700;margin-bottom:8px;"></div>
                                            <div id="predPriceRange" style="font-size:0.9rem;color:var(--text-secondary);"></div>
                                        </div>
                                        <div style="text-align:right;">
                                            <div style="font-size:0.85rem;color:var(--text-secondary);margin-bottom:8px;">ƒê·ªô tin c·∫≠y</div>
                                            <div id="predConfidence" style="font-size:1.25rem;font-weight:600;"></div>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Reasons -->
                                <div id="predReasons" style="background:var(--bg-primary);border-radius:12px;padding:20px;margin-bottom:20px;">
                                    <div style="font-size:1rem;font-weight:600;margin-bottom:16px;display:flex;align-items:center;gap:8px;">
                                        <i class="fas fa-lightbulb" style="color:#f59e0b;"></i> L√Ω do d·ª± ƒëo√°n
                                    </div>
                                    <div id="reasonsList" style="display:flex;flex-direction:column;gap:12px;"></div>
                                </div>
                                
                                <!-- Chart -->
                                <div class="chart-container"><canvas id="predChart"></canvas></div>
                                
                                <!-- Related News -->
                                <div id="predNews" style="background:var(--bg-primary);border-radius:12px;padding:20px;margin-top:20px;">
                                    <div style="font-size:1rem;font-weight:600;margin-bottom:16px;display:flex;align-items:center;gap:8px;">
                                        <i class="fas fa-newspaper" style="color:#3b82f6;"></i> Tin t·ª©c li√™n quan
                                    </div>
                                    <div id="predNewsList" style="display:flex;flex-direction:column;gap:10px;"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>
    <div class="toast" id="toast"></div>

    <script>
        const API = '';
        let stocks = [], currentSymbol = 'VNM', days = 90, priceChart, predChart, pricesCache = {};

        document.addEventListener('DOMContentLoaded', async () => { 
            try {
                console.log('üöÄ Starting app...');
                initChart();
                setupNav();
                await initDates();
                await loadStats();
                await loadStocks();
                console.log('‚úÖ App loaded successfully');
            } catch(e) {
                console.error('‚ùå App init error:', e);
            }
        });

        function setupNav() {
            document.querySelectorAll('.nav-item').forEach(item => {
                item.addEventListener('click', () => {
                    document.querySelectorAll('.nav-item').forEach(i => i.classList.remove('active'));
                    document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
                    item.classList.add('active');
                    const page = item.dataset.page;
                    document.getElementById('page-' + page).classList.add('active');
                    const titles = {dashboard:'Dashboard',market:'B·∫£ng gi√° th·ªã tr∆∞·ªùng',news:'Tin t·ª©c & Sentiment',models:'M√¥ h√¨nh Machine Learning',predict:'D·ª± ƒëo√°n gi√° c·ªï phi·∫øu'};
                    document.getElementById('pageTitle').textContent = titles[page] || 'Dashboard';
                    if (page === 'market') loadMarketTable();
                    if (page === 'news') { populateNewsSymbol(); loadNews(); }
                });
            });
            document.querySelectorAll('.time-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    document.querySelectorAll('.time-btn').forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');
                    days = parseInt(btn.dataset.days);
                    loadPrices(currentSymbol, days);
                });
            });
            document.getElementById('searchInput').addEventListener('input', e => {
                const q = e.target.value.toLowerCase();
                renderStocks(stocks.filter(s => s.symbol.toLowerCase().includes(q) || s.name?.toLowerCase().includes(q)));
            });
        }

        async function loadStats() {
            try {
                const r = await fetch(API + '/api/stats/overview');
                const d = await r.json();
                document.getElementById('statStocks').textContent = d.stocks?.active || 0;
                document.getElementById('statPrices').textContent = formatNum(d.price_records || 0);
                document.getElementById('statPredictions').textContent = formatNum(d.predictions || 0);
            } catch(e) { console.error(e); }
        }

        async function loadStocks() {
            console.log('üìä Loading stocks...');
            try {
                const r = await fetch(API + '/api/stocks?limit=100');
                if (!r.ok) throw new Error('HTTP ' + r.status);
                stocks = await r.json();
                console.log('‚úÖ Loaded', stocks.length, 'stocks');
                renderStocks(stocks);
                populatePredSelect();
                if (stocks.length > 0) {
                    selectStock(stocks[0].symbol);
                    loadAllStockPrices();
                }
            } catch(e) {
                console.error('‚ùå loadStocks error:', e);
                document.getElementById('stockGrid').innerHTML = '<div style="padding:20px;text-align:center;color:var(--text-secondary)"><p>L·ªói t·∫£i d·ªØ li·ªáu: ' + e.message + '</p><button class="btn btn-primary" onclick="loadStocks()">Th·ª≠ l·∫°i</button></div>';
            }
        }

        async function loadAllStockPrices() {
            // Load gi√° m·ªõi nh·∫•t cho t·∫•t c·∫£ m√£ c·ªï phi·∫øu
            for (const s of stocks) {
                try {
                    const r = await fetch(API + `/api/prices/${s.symbol}?limit=2`);
                    const data = await r.json();
                    if (data && data.length > 0) {
                        const latest = data[data.length - 1];
                        const prev = data.length > 1 ? data[data.length - 2] : latest;
                        const change = prev.close > 0 ? ((latest.close - prev.close) / prev.close * 100).toFixed(2) : 0;
                        
                        // C·∫≠p nh·∫≠t gi√° trong grid
                        const pe = document.getElementById('p-' + s.symbol);
                        if (pe) {
                            pe.textContent = fmtPrice(latest.close);
                            pe.className = 'price ' + (change < 0 ? 'down' : '');
                        }
                        const ce = document.getElementById('c-' + s.symbol);
                        if (ce) {
                            ce.innerHTML = `<span class="${change>=0?'up':'down'}">${change>=0?'‚ñ≤':'‚ñº'} ${Math.abs(change)}%</span>`;
                        }
                        
                        // Cache d·ªØ li·ªáu
                        pricesCache[s.symbol] = data;
                    }
                } catch(e) { 
                    console.log(`Error loading ${s.symbol}:`, e); 
                }
            }
        }

        function renderStocks(list) {
            document.getElementById('stockGrid').innerHTML = list.map(s => `
                <div class="stock-card ${s.symbol===currentSymbol?'active':''}" onclick="selectStock('${s.symbol}')">
                    <div class="symbol">${s.symbol}</div>
                    <div class="name">${(s.name || '').substring(0,20)}</div>
                    <div class="price" id="p-${s.symbol}">--</div>
                    <div class="change" id="c-${s.symbol}">--</div>
                </div>
            `).join('');
        }

        function populatePredSelect() {
            document.getElementById('predSymbol').innerHTML = stocks.map(s => `<option value="${s.symbol}">${s.symbol}</option>`).join('');
            // Also populate chart selector
            document.getElementById('chartSymbolSelect').innerHTML = stocks.map(s => `<option value="${s.symbol}">${s.symbol} - ${(s.name || '').substring(0,25)}</option>`).join('');
        }

        async function selectStock(symbol) {
            if (!symbol) return;
            currentSymbol = symbol;
            document.querySelectorAll('.stock-card').forEach(el => el.classList.toggle('active', el.querySelector('.symbol')?.textContent === symbol));
            document.getElementById('chartSymbolSelect').value = symbol;
            await loadPrices(symbol, days);
        }

        async function loadPrices(symbol, limit) {
            try {
                const r = await fetch(API + `/api/prices/${symbol}?limit=${limit}`);
                const data = await r.json();
                pricesCache[symbol] = data;
                if (data.length === 0) { toast(`Ch∆∞a c√≥ d·ªØ li·ªáu ${symbol}`, 'error'); return; }
                updateChart(data);
                const l = data[data.length - 1];
                document.getElementById('infoOpen').textContent = fmtPrice(l.open);
                document.getElementById('infoHigh').textContent = fmtPrice(l.high);
                document.getElementById('infoLow').textContent = fmtPrice(l.low);
                document.getElementById('infoClose').textContent = fmtPrice(l.close);
                document.getElementById('infoVolume').textContent = fmtVol(l.volume);
                const change = ((l.close - l.open) / l.open * 100).toFixed(2);
                document.getElementById('infoChange').innerHTML = `<span class="${change>=0?'up':'down'}">${change>=0?'+':''}${change}%</span>`;
                const pe = document.getElementById('p-' + symbol);
                if (pe) {
                    pe.textContent = fmtPrice(l.close);
                    pe.className = 'price ' + (change >= 0 ? '' : 'down');
                }
                const ce = document.getElementById('c-' + symbol);
                if (ce) {
                    ce.innerHTML = `<span class="${change>=0?'up':'down'}">${change>=0?'‚ñ≤':'‚ñº'} ${Math.abs(change)}%</span>`;
                }
            } catch(e) { console.error(e); }
        }

        async function loadMarketTable() {
            const tbody = document.getElementById('marketTable');
            tbody.innerHTML = '<tr><td colspan="12" style="text-align:center;padding:40px;"><i class="fas fa-spinner fa-spin"></i> ƒêang t·∫£i b·∫£ng gi√°...</td></tr>';
            
            const rows = [];
            for (const s of stocks.slice(0, 30)) {
                try {
                    const r = await fetch(API + `/api/prices/${s.symbol}?limit=2`);
                    if (r.ok) {
                        const data = await r.json();
                        if (data && data.length > 0) {
                            const p = data[data.length - 1]; // Latest price
                            const prev = data.length > 1 ? data[data.length - 2] : p;
                            
                            // Real data from API
                            const open = p.open;
                            const high = p.high;
                            const low = p.low;
                            const close = p.close;
                            const vol = p.volume || 0;
                            const date = p.date;
                            
                            // Calculate reference, ceiling, floor from previous close
                            const ref = prev.close;
                            const ceil = ref * 1.07;
                            const floor = ref * 0.93;
                            
                            // Calculate change
                            const change = close - ref;
                            const pct = ref > 0 ? (change / ref * 100) : 0;
                            
                            // Determine color class
                            let priceClass = 'price-ref';
                            if (close >= ceil * 0.99) priceClass = 'price-ceil';
                            else if (close <= floor * 1.01) priceClass = 'price-floor';
                            else if (change > 0) priceClass = 'price-up';
                            else if (change < 0) priceClass = 'price-down';
                            
                            rows.push(`
                                <tr onclick="selectStock('${s.symbol}');document.querySelector('[data-page=dashboard]').click()">
                                    <td class="sticky-col" style="font-weight:700;color:${change>=0?'#00e676':'#ff1744'}">${s.symbol}</td>
                                    <td class="price-ref">${fmtPrice(ref)}</td>
                                    <td class="price-ceil">${fmtPrice(ceil)}</td>
                                    <td class="price-floor">${fmtPrice(floor)}</td>
                                    <td>${fmtPrice(open)}</td>
                                    <td class="price-up">${fmtPrice(high)}</td>
                                    <td class="price-down">${fmtPrice(low)}</td>
                                    <td class="${priceClass}" style="font-weight:700;">${fmtPrice(close)}</td>
                                    <td class="${priceClass}">${change>=0?'+':''}${(change*1000).toFixed(0)}</td>
                                    <td class="${priceClass}">${change>=0?'+':''}${pct.toFixed(2)}%</td>
                                    <td style="color:#64748b;">${fmtVol(vol)}</td>
                                    <td style="color:#64748b;font-size:0.75rem;">${date}</td>
                                </tr>
                            `);
                        }
                    }
                } catch(e) { console.error(s.symbol, e); }
            }
            tbody.innerHTML = rows.length ? rows.join('') : '<tr><td colspan="12" style="text-align:center;color:var(--text-secondary);padding:40px;">Kh√¥ng c√≥ d·ªØ li·ªáu</td></tr>';
        }

        function initChart() {
            const ctx = document.getElementById('priceChart').getContext('2d');
            priceChart = new Chart(ctx, {
                type: 'line',
                data: { labels: [], datasets: [{ label: 'Gi√°', data: [], borderColor: '#3b82f6', backgroundColor: 'rgba(59,130,246,0.1)', fill: true, tension: 0.4, pointRadius: 0 }] },
                options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } }, scales: { x: { grid: { color: '#334155' }, ticks: { color: '#64748b' } }, y: { grid: { color: '#334155' }, ticks: { color: '#64748b', callback: v => fmtPrice(v) } } } }
            });
        }

        function updateChart(data) {
            priceChart.data.labels = data.map(d => d.date);
            priceChart.data.datasets[0].data = data.map(d => d.close);
            priceChart.update();
        }

        // Kh·ªüi t·∫°o ng√†y m·∫∑c ƒë·ªãnh
        let latestDataDate = null;
        async function initDates() {
            console.log('üìÖ initDates...');
            const today = new Date();
            const oneYearAgo = new Date();
            oneYearAgo.setFullYear(today.getFullYear() - 1);
            
            const toDateEl = document.getElementById('toDate');
            const fromDateEl = document.getElementById('fromDate');
            
            if (toDateEl) toDateEl.value = today.toISOString().split('T')[0];
            if (fromDateEl) fromDateEl.value = oneYearAgo.toISOString().split('T')[0];
            
            // L·∫•y ng√†y giao d·ªãch g·∫ßn nh·∫•t t·ª´ API
            try {
                const r = await fetch(API + '/api/prices/VNM?limit=1');
                const data = await r.json();
                if (data && data.length > 0 && data[0].date) {
                    latestDataDate = data[0].date;
                    updateDataStatus(data[0].date);
                } else {
                    updateDataStatus(null);
                }
            } catch(e) {
                console.log('initDates error:', e);
                updateDataStatus(null);
            }
        }

        function updateDataStatus(dateStr) {
            const banner = document.getElementById('latestDataDate');
            const status = document.getElementById('dataStatus');
            const btn = document.getElementById('fetchLatestBtn');
            
            if (!dateStr) {
                banner.textContent = 'Ch∆∞a c√≥ d·ªØ li·ªáu';
                status.innerHTML = '<i class="fas fa-exclamation-circle"></i> Ch∆∞a c√≥';
                status.style.background = 'rgba(239,68,68,0.2)';
                status.style.color = '#ef4444';
                return;
            }
            
            const dataDate = new Date(dateStr);
            const today = new Date();
            const dayName = ['Ch·ªß nh·∫≠t','Th·ª© 2','Th·ª© 3','Th·ª© 4','Th·ª© 5','Th·ª© 6','Th·ª© 7'][dataDate.getDay()];
            banner.textContent = `${dayName}, ${dateStr}`;
            
            // T√≠nh s·ªë ng√†y ch√™nh l·ªách
            const diffDays = Math.floor((today - dataDate) / (1000 * 60 * 60 * 24));
            
            if (diffDays <= 1 || (today.getDay() === 1 && diffDays <= 3)) {
                // D·ªØ li·ªáu m·ªõi (ho·∫∑c l√† th·ª© 2 v√† d·ªØ li·ªáu t·ª´ th·ª© 6)
                status.innerHTML = '<i class="fas fa-check-circle"></i> ƒê√£ c·∫≠p nh·∫≠t';
                status.style.background = 'rgba(16,185,129,0.2)';
                status.style.color = '#10b981';
            } else {
                status.innerHTML = `<i class="fas fa-clock"></i> ${diffDays} ng√†y tr∆∞·ªõc`;
                status.style.background = 'rgba(245,158,11,0.2)';
                status.style.color = '#f59e0b';
            }
        }

        async function fetchLatestData() {
            const btn = document.getElementById('fetchLatestBtn');
            btn.disabled = true;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> ƒêang fetch...';
            toast('ƒêang fetch d·ªØ li·ªáu m·ªõi cho t·∫•t c·∫£ m√£...');
            
            try {
                const r = await fetch(API + '/api/data/fetch-all', { method: 'POST' });
                const d = await r.json();
                toast(`‚úì Fetch th√†nh c√¥ng! ${d.summary?.success || 0} m√£`);
                
                // Reload l·∫°i d·ªØ li·ªáu
                await initDates();
                loadStats();
                if (document.getElementById('page-market').classList.contains('active')) {
                    loadMarketTable();
                }
            } catch(e) {
                toast('L·ªói fetch: ' + e.message, 'error');
            } finally {
                btn.disabled = false;
                btn.innerHTML = '<i class="fas fa-cloud-download-alt"></i> Fetch d·ªØ li·ªáu m·ªõi';
            }
        }

        async function fetchCurrentStock() {
            if (!currentSymbol) return;
            const fromDate = document.getElementById('fromDate').value;
            const toDate = document.getElementById('toDate').value;
            if (!fromDate || !toDate) { toast('Vui l√≤ng ch·ªçn ng√†y', 'error'); return; }
            toast(`ƒêang fetch ${currentSymbol} (${fromDate} ‚Üí ${toDate})...`);
            try {
                const r = await fetch(API + `/api/data/fetch/${currentSymbol}?from_date=${fromDate}&to_date=${toDate}`, { method: 'POST' });
                const d = await r.json();
                if (d.status === 'success') { toast(`‚úì ${d.records_added} records`); loadPrices(currentSymbol, days); loadStats(); }
                else toast(d.detail || d.message || 'Error', 'error');
            } catch(e) { toast(e.message, 'error'); }
        }

        async function fetchAllData() {
            const fromDate = document.getElementById('fromDate').value;
            const toDate = document.getElementById('toDate').value;
            if (!fromDate || !toDate) { toast('Vui l√≤ng ch·ªçn ng√†y', 'error'); return; }
            toast(`ƒêang fetch t·∫•t c·∫£ (${fromDate} ‚Üí ${toDate})...`);
            try {
                const r = await fetch(API + `/api/data/fetch-all?from_date=${fromDate}&to_date=${toDate}`, { method: 'POST' });
                const d = await r.json();
                toast(`‚úì ${d.summary?.success||0} m√£ th√†nh c√¥ng`);
                loadStats(); loadMarketTable();
            } catch(e) { toast(e.message, 'error'); }
        }

        async function initDB() {
            toast('ƒêang kh·ªüi t·∫°o...');
            try {
                const r = await fetch(API + '/api/admin/init-db', { method: 'POST' });
                const d = await r.json();
                toast(d.status === 'success' ? `‚úì Th√™m ${d.stocks_added.length} m√£` : d.message);
                loadStocks(); loadStats();
            } catch(e) { toast(e.message, 'error'); }
        }

        async function runPredict() {
            const symbol = document.getElementById('predSymbol').value;
            const pdays = parseInt(document.getElementById('predDays').value);
            const model = document.getElementById('predModel').value;
            if (!symbol) { toast('Ch·ªçn m√£ CK', 'error'); return; }
            
            const btn = document.getElementById('predBtn');
            btn.disabled = true;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> ƒêang ph√¢n t√≠ch...';
            toast(`ƒêang ph√¢n t√≠ch ${symbol}...`);
            
            try {
                // Get price data
                const cached = pricesCache[symbol] || [];
                const lastPrice = cached.length ? cached[cached.length-1].close : 50;
                const prevPrice = cached.length > 1 ? cached[cached.length-2].close : lastPrice;
                
                // Get sentiment from news
                let sentimentData = null;
                try {
                    const newsR = await fetch(`${API}/api/news/${symbol}`);
                    sentimentData = await newsR.json();
                } catch(e) { console.log('News fetch error:', e); }
                
                // Calculate technical indicators
                const prices = cached.map(d => d.close);
                const volumes = cached.map(d => d.volume);
                const sma5 = prices.length >= 5 ? prices.slice(-5).reduce((a,b) => a+b, 0) / 5 : lastPrice;
                const sma20 = prices.length >= 20 ? prices.slice(-20).reduce((a,b) => a+b, 0) / 20 : lastPrice;
                const avgVol = volumes.length >= 10 ? volumes.slice(-10).reduce((a,b) => a+b, 0) / 10 : 0;
                const lastVol = cached.length ? cached[cached.length-1].volume : 0;
                
                // Calculate momentum
                const momentum = prices.length >= 5 ? ((lastPrice - prices[prices.length-5]) / prices[prices.length-5] * 100) : 0;
                
                // Determine prediction direction based on multiple factors
                let score = 0;
                const reasons = [];
                
                // Factor 1: Sentiment from news
                if (sentimentData?.sentiment_summary) {
                    const sent = sentimentData.sentiment_summary;
                    if (sent.overall === 'positive') {
                        score += 2;
                        reasons.push({ type: 'positive', icon: 'üì∞', text: `Tin t·ª©c t√≠ch c·ª±c (${sent.positive_count} tin t·ªët)`, detail: sent.recommendation });
                    } else if (sent.overall === 'negative') {
                        score -= 2;
                        reasons.push({ type: 'negative', icon: 'üì∞', text: `Tin t·ª©c ti√™u c·ª±c (${sent.negative_count} tin x·∫•u)`, detail: sent.recommendation });
                    } else {
                        reasons.push({ type: 'neutral', icon: 'üì∞', text: 'Tin t·ª©c trung l·∫≠p', detail: 'Kh√¥ng c√≥ t√≠n hi·ªáu r√µ r√†ng t·ª´ tin t·ª©c' });
                    }
                }
                
                // Factor 2: SMA crossover
                if (lastPrice > sma5 && sma5 > sma20) {
                    score += 1.5;
                    reasons.push({ type: 'positive', icon: 'üìà', text: 'Xu h∆∞·ªõng tƒÉng (Golden Cross)', detail: `Gi√° ${fmtPrice(lastPrice)} > SMA5 ${fmtPrice(sma5)} > SMA20 ${fmtPrice(sma20)}` });
                } else if (lastPrice < sma5 && sma5 < sma20) {
                    score -= 1.5;
                    reasons.push({ type: 'negative', icon: 'üìâ', text: 'Xu h∆∞·ªõng gi·∫£m (Death Cross)', detail: `Gi√° ${fmtPrice(lastPrice)} < SMA5 ${fmtPrice(sma5)} < SMA20 ${fmtPrice(sma20)}` });
                } else {
                    reasons.push({ type: 'neutral', icon: '‚û°Ô∏è', text: 'Xu h∆∞·ªõng ƒëi ngang', detail: `SMA5: ${fmtPrice(sma5)}, SMA20: ${fmtPrice(sma20)}` });
                }
                
                // Factor 3: Momentum
                if (momentum > 3) {
                    score += 1;
                    reasons.push({ type: 'positive', icon: 'üöÄ', text: `ƒê·ªông l∆∞·ª£ng m·∫°nh (+${momentum.toFixed(1)}%)`, detail: 'Gi√° tƒÉng m·∫°nh trong 5 phi√™n g·∫ßn ƒë√¢y' });
                } else if (momentum < -3) {
                    score -= 1;
                    reasons.push({ type: 'negative', icon: 'üîª', text: `ƒê·ªông l∆∞·ª£ng y·∫øu (${momentum.toFixed(1)}%)`, detail: 'Gi√° gi·∫£m trong 5 phi√™n g·∫ßn ƒë√¢y' });
                }
                
                // Factor 4: Volume
                if (lastVol > avgVol * 1.5) {
                    const volReason = score > 0 ? 
                        { type: 'positive', icon: 'üìä', text: 'Kh·ªëi l∆∞·ª£ng ƒë·ªôt bi·∫øn (t√≠ch l≈©y)', detail: `KL h√¥m nay ${fmtVol(lastVol)} > TB ${fmtVol(avgVol)} - D·∫•u hi·ªáu t√≠ch l≈©y` } :
                        { type: 'negative', icon: 'üìä', text: 'Kh·ªëi l∆∞·ª£ng ƒë·ªôt bi·∫øn (ph√¢n ph·ªëi)', detail: `KL h√¥m nay ${fmtVol(lastVol)} > TB ${fmtVol(avgVol)} - C√≥ th·ªÉ ƒëang ph√¢n ph·ªëi` };
                    reasons.push(volReason);
                    score += score > 0 ? 0.5 : -0.5;
                }
                
                // Factor 5: Price change
                const priceChange = ((lastPrice - prevPrice) / prevPrice * 100);
                if (priceChange > 2) {
                    score += 0.5;
                    reasons.push({ type: 'positive', icon: 'üíπ', text: `Phi√™n tr∆∞·ªõc tƒÉng +${priceChange.toFixed(1)}%`, detail: 'T√¢m l√Ω th·ªã tr∆∞·ªùng t√≠ch c·ª±c' });
                } else if (priceChange < -2) {
                    score -= 0.5;
                    reasons.push({ type: 'negative', icon: 'üíπ', text: `Phi√™n tr∆∞·ªõc gi·∫£m ${priceChange.toFixed(1)}%`, detail: '√Åp l·ª±c b√°n c√≥ th·ªÉ ti·∫øp t·ª•c' });
                }
                
                // Calculate prediction
                const direction = score > 1 ? 'up' : score < -1 ? 'down' : 'sideway';
                const confidence = Math.min(95, 50 + Math.abs(score) * 10);
                const volatility = direction === 'up' ? 0.015 : direction === 'down' ? -0.01 : 0.005;
                
                // Generate prediction data
                const labels = [], actual = [], pred = [];
                cached.slice(-30).forEach(d => { labels.push(d.date); actual.push(d.close); pred.push(null); });
                
                let price = lastPrice;
                const drift = score * 0.003; // Base drift from score
                for (let i = 1; i <= pdays; i++) {
                    const dt = new Date(); dt.setDate(dt.getDate() + i);
                    labels.push(dt.toISOString().split('T')[0]);
                    actual.push(null);
                    price *= (1 + drift + (Math.random() - 0.5) * 0.02);
                    pred.push(price);
                }
                
                const finalPrice = pred[pred.length - 1];
                const changePercent = ((finalPrice - lastPrice) / lastPrice * 100);
                
                // Update UI - Summary
                const directionEl = document.getElementById('predDirection');
                if (direction === 'up') {
                    directionEl.innerHTML = `<span style="color:#10b981;">üöÄ D·ª∞ ƒêO√ÅN TƒÇNG +${changePercent.toFixed(1)}%</span>`;
                } else if (direction === 'down') {
                    directionEl.innerHTML = `<span style="color:#ef4444;">üìâ D·ª∞ ƒêO√ÅN GI·∫¢M ${changePercent.toFixed(1)}%</span>`;
                } else {
                    directionEl.innerHTML = `<span style="color:#f59e0b;">‚û°Ô∏è D·ª∞ ƒêO√ÅN ƒêI NGANG</span>`;
                }
                
                document.getElementById('predPriceRange').innerHTML = `
                    Gi√° hi·ªán t·∫°i: <strong>${fmtPrice(lastPrice)}</strong> ‚Üí 
                    D·ª± ƒëo√°n sau ${pdays} ng√†y: <strong>${fmtPrice(finalPrice)}</strong>
                `;
                
                document.getElementById('predConfidence').innerHTML = `
                    <span style="color:${confidence > 70 ? '#10b981' : confidence > 50 ? '#f59e0b' : '#ef4444'};">
                        ${confidence.toFixed(0)}%
                    </span>
                `;
                
                // Update UI - Reasons
                document.getElementById('reasonsList').innerHTML = reasons.map(r => `
                    <div style="display:flex;align-items:flex-start;gap:12px;padding:12px;background:var(--bg-card);border-radius:8px;border-left:3px solid ${r.type === 'positive' ? '#10b981' : r.type === 'negative' ? '#ef4444' : '#94a3b8'};">
                        <span style="font-size:1.5rem;">${r.icon}</span>
                        <div>
                            <div style="font-weight:600;color:${r.type === 'positive' ? '#10b981' : r.type === 'negative' ? '#ef4444' : 'var(--text-primary)'};">${r.text}</div>
                            <div style="font-size:0.85rem;color:var(--text-secondary);margin-top:4px;">${r.detail}</div>
                        </div>
                    </div>
                `).join('');
                
                // Update UI - Related News
                if (sentimentData?.news?.length) {
                    document.getElementById('predNewsList').innerHTML = sentimentData.news.slice(0, 3).map(n => `
                        <div style="padding:10px;background:var(--bg-card);border-radius:8px;border-left:3px solid ${n.sentiment === 'positive' ? '#10b981' : n.sentiment === 'negative' ? '#ef4444' : '#94a3b8'};">
                            <div style="font-weight:500;font-size:0.9rem;">${n.title}</div>
                            <div style="font-size:0.75rem;color:var(--text-secondary);margin-top:4px;">${n.source} ‚Ä¢ ${n.published_at}</div>
                        </div>
                    `).join('');
                } else {
                    document.getElementById('predNewsList').innerHTML = '<div style="color:var(--text-secondary);font-size:0.9rem;">Kh√¥ng c√≥ tin t·ª©c li√™n quan</div>';
                }
                
                // Update Chart
                if (!predChart) {
                    predChart = new Chart(document.getElementById('predChart').getContext('2d'), {
                        type: 'line',
                        data: { labels, datasets: [
                            { label: 'Th·ª±c t·∫ø', data: actual, borderColor: '#3b82f6', tension: 0.4, pointRadius: 2 }, 
                            { label: 'D·ª± ƒëo√°n', data: pred, borderColor: direction === 'up' ? '#10b981' : direction === 'down' ? '#ef4444' : '#f59e0b', borderDash: [5,5], tension: 0.4, pointRadius: 2 }
                        ]},
                        options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { labels: { color: '#94a3b8' } } }, scales: { x: { grid: { color: '#334155' }, ticks: { color: '#64748b' } }, y: { grid: { color: '#334155' }, ticks: { color: '#64748b', callback: v => fmtPrice(v) } } } }
                    });
                } else {
                    predChart.data.labels = labels;
                    predChart.data.datasets[0].data = actual;
                    predChart.data.datasets[1].data = pred;
                    predChart.data.datasets[1].borderColor = direction === 'up' ? '#10b981' : direction === 'down' ? '#ef4444' : '#f59e0b';
                    predChart.update();
                }
                
                document.getElementById('predResult').style.display = 'block';
                toast(`‚úì D·ª± ƒëo√°n ${symbol} ho√†n t·∫•t`);
                
            } catch(e) {
                toast('L·ªói: ' + e.message, 'error');
            } finally {
                btn.disabled = false;
                btn.innerHTML = '<i class="fas fa-play"></i> Ch·∫°y d·ª± ƒëo√°n';
            }
        }

        function fmtPrice(p) { return p == null ? '--' : new Intl.NumberFormat('vi-VN').format(p * 1000) + ' VND'; }
        function fmtVol(v) { return v == null ? '--' : v >= 1e6 ? (v/1e6).toFixed(1)+'M' : v >= 1e3 ? (v/1e3).toFixed(0)+'K' : v; }
        function formatNum(n) { return n >= 1e6 ? (n/1e6).toFixed(1)+'M' : n >= 1e3 ? (n/1e3).toFixed(1)+'K' : n; }
        function toast(msg, type='success') { const t = document.getElementById('toast'); t.textContent = msg; t.className = 'toast' + (type==='error'?' error':''); t.style.display = 'block'; setTimeout(() => t.style.display = 'none', 3000); }

        // =====================================================
        // NEWS & SENTIMENT FUNCTIONS
        // =====================================================
        
        function populateNewsSymbol() {
            const select = document.getElementById('newsSymbol');
            if (select.options.length <= 1) {
                stocks.forEach(s => {
                    const opt = document.createElement('option');
                    opt.value = s.symbol;
                    opt.textContent = `${s.symbol} - ${s.name || ''}`;
                    select.appendChild(opt);
                });
            }
        }

        async function loadNews() {
            const symbol = document.getElementById('newsSymbol').value;
            const newsList = document.getElementById('newsList');
            const summaryDiv = document.getElementById('sentimentSummary');
            
            newsList.innerHTML = '<div style="text-align:center;padding:40px;"><i class="fas fa-spinner fa-spin" style="font-size:2rem;color:var(--accent);"></i><p style="margin-top:16px;color:var(--text-secondary);">ƒêang t·∫£i tin t·ª©c...</p></div>';
            
            try {
                const url = symbol ? `${API}/api/news/${symbol}` : `${API}/api/news`;
                const r = await fetch(url);
                const data = await r.json();
                
                if (data.status === 'success') {
                    // Show sentiment summary if symbol selected
                    if (symbol && data.sentiment_summary) {
                        summaryDiv.style.display = 'block';
                        const sum = data.sentiment_summary;
                        
                        // Update counts
                        document.getElementById('posCount').textContent = sum.positive_count || 0;
                        document.getElementById('neuCount').textContent = sum.neutral_count || 0;
                        document.getElementById('negCount').textContent = sum.negative_count || 0;
                        
                        // Update sentiment badge
                        const badge = document.getElementById('sentimentBadge');
                        const colors = { positive: '#10b981', negative: '#ef4444', neutral: '#94a3b8' };
                        const labels = { positive: 'üü¢ T√çCH C·ª∞C', negative: 'üî¥ TI√äU C·ª∞C', neutral: 'üü° TRUNG L·∫¨P' };
                        badge.textContent = `${labels[sum.overall] || 'TRUNG L·∫¨P'} (${sum.avg_score > 0 ? '+' : ''}${sum.avg_score})`;
                        badge.style.color = colors[sum.overall] || colors.neutral;
                        
                        // Update recommendation
                        document.getElementById('recommendation').innerHTML = sum.recommendation || '';
                    } else {
                        summaryDiv.style.display = 'none';
                    }
                    
                    // Render news list
                    const news = data.news || [];
                    if (news.length === 0) {
                        newsList.innerHTML = '<div style="text-align:center;padding:40px;color:var(--text-secondary);"><i class="fas fa-inbox" style="font-size:3rem;margin-bottom:16px;opacity:0.3;"></i><p>Kh√¥ng c√≥ tin t·ª©c</p></div>';
                        return;
                    }
                    
                    newsList.innerHTML = news.map(n => `
                        <div class="news-item ${n.sentiment}">
                            <div class="news-title">${n.title}</div>
                            <div class="news-summary">${n.summary}</div>
                            <div class="news-impact">${n.impact}</div>
                            <div class="news-meta">
                                <span>
                                    <span class="news-source">${n.source}</span> ‚Ä¢ ${n.published_at}
                                </span>
                                <span class="news-sentiment ${n.sentiment}">
                                    ${n.sentiment === 'positive' ? 'üìà T√≠ch c·ª±c' : n.sentiment === 'negative' ? 'üìâ Ti√™u c·ª±c' : '‚û°Ô∏è Trung l·∫≠p'}
                                    (${n.sentiment_score > 0 ? '+' : ''}${n.sentiment_score})
                                </span>
                            </div>
                        </div>
                    `).join('');
                    
                    toast(`‚úì ƒê√£ t·∫£i ${news.length} tin t·ª©c`);
                } else {
                    throw new Error(data.detail || 'Kh√¥ng th·ªÉ t·∫£i tin t·ª©c');
                }
            } catch (e) {
                newsList.innerHTML = `<div style="text-align:center;padding:40px;color:var(--danger);"><i class="fas fa-exclamation-circle" style="font-size:2rem;margin-bottom:16px;"></i><p>L·ªói: ${e.message}</p></div>`;
                toast('L·ªói t·∫£i tin t·ª©c', 'error');
            }
        }
    </script>
</body>
</html>
